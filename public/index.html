<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Trust Fabric</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 400: '#94a3b8', 300: '#cbd5e1' },
                        cyan: { 500: '#06b6d4', 600: '#0891b2', 700: '#0e7490' },
                        amber: { 300: '#fcd34d', 400: '#f59e0b', 700: '#b45309', 900: '#78350f' },
                        green: { 400: '#22c55e', 500: '#16a34a' },
                        yellow: { 500: '#eab308' },
                        red: { 400: '#ef4444', 500: '#dc2626', 700: '#b91c1c', 900: '#7f1d1d' },
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-300">
    <div id="root"></div>

    <!-- React, ReactDOM, Axios, and Recharts via ESM CDN -->
    <script type="module">
        import React, { useState } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import axios from 'https://esm.sh/axios@1.6.8';
        import { BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } from 'https://esm.sh/recharts@2.12.7?deps=react@18.2.0';

        // --- Integrity Panel Component ---
        const IntegrityPanel = () => {
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const testIntegrity = async () => {
                setLoading(true);
                setError('');
                setResult(null);
                try {
                    const response = await axios.post('http://127.0.0.1:8000/api/integrity/validate', {
                        records: [{age: 30, income: 50000, churn: "No"}, {age: 40, income: 60000, churn: "Yes"}, {age: null, income: 70000, churn: "No"}],
                        target_col: "churn"
                    });
                    setResult(response.data);
                } catch (err) {
                    setError('Failed to connect to backend API. Is the server running?');
                    console.error('API Error:', err);
                }
                setLoading(false);
            };

            const getAlertColor = (level) => ({ 'TARGET': 'bg-green-500', 'CAUTION': 'bg-yellow-500', 'RISK': 'bg-red-500' }[level] || 'bg-gray-500');

            return React.createElement('div', { className: 'space-y-6' },
                React.createElement('div', { className: 'bg-slate-800 rounded-lg p-6' },
                    React.createElement('h2', { className: 'text-xl font-semibold mb-2' }, 'Data Integrity Monitor'),
                    React.createElement('p', { className: 'text-slate-400 mb-4' }, '"Garbage in â†’ litigation out." Assess dataset health before training.'),
                    React.createElement('button', { onClick: testIntegrity, disabled: loading, className: 'bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg font-medium disabled:opacity-50' }, loading ? 'Assessing...' : 'Assess Integrity')
                ),
                error && React.createElement('div', { className: 'bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg' }, error),
                result && React.createElement(React.Fragment, null,
                    React.createElement('div', { className: 'bg-slate-800 rounded-lg p-6' },
                        React.createElement('div', { className: 'flex items-center justify-between' },
                            React.createElement('div', null,
                                React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Data Trust Index'),
                                React.createElement('p', { className: 'text-4xl font-bold mt-1' }, result.integrity_score.toFixed(1)),
                            ),
                            React.createElement('div', { className: `${getAlertColor(result.alert_level)} px-4 py-2 rounded-lg` },
                                React.createElement('p', { className: 'text-white font-semibold' }, result.alert_level)
                            )
                        )
                    ),
                    React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                        React.createElement('div', { className: 'bg-slate-800 p-4 rounded-lg' }, React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Completeness'), React.createElement('p', { className: 'text-2xl font-semibold' }, `${(result.missing_score * 100).toFixed(1)}%`)),
                        React.createElement('div', { className: 'bg-slate-800 p-4 rounded-lg' }, React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Consistency'), React.createElement('p', { className: 'text-2xl font-semibold' }, `${(result.schema_score * 100).toFixed(1)}%`)),
                        React.createElement('div', { className: 'bg-slate-800 p-4 rounded-lg' }, React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Uniqueness'), React.createElement('p', { className: 'text-2xl font-semibold' }, `${(result.duplicate_score * 100).toFixed(1)}%`)),
                        result.imbalance_score && React.createElement('div', { className: 'bg-slate-800 p-4 rounded-lg' }, React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Class Balance'), React.createElement('p', { className: 'text-2xl font-semibold' }, `${(result.imbalance_score * 100).toFixed(1)}%`))
                    ),
                    React.createElement('div', { className: 'bg-slate-800 rounded-lg p-6' },
                        React.createElement('h3', { className: 'font-semibold mb-4' }, 'Key Recommendations'),
                        React.createElement('ul', { className: 'list-disc list-inside space-y-2 text-slate-300' }, result.recommendations.map((rec, i) => React.createElement('li', { key: i }, rec)))
                    )
                )
            );
        };

        // --- GPU Panel Component ---
        const GPUPanel = () => {
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const sampleExperiments = [{ "model_type": "LogisticRegression", "batch_size": 32, "epochs": 10, "gpu_time_ms": 55.1 }, { "model_type": "RandomForest", "batch_size": 128, "epochs": 100, "gpu_time_ms": 2050.5 }, { "model_type": "XGBoost", "batch_size": 64, "epochs": 20, "gpu_time_ms": 315.2 }, { "model_type": "RandomForest", "batch_size": 256, "epochs": 20, "gpu_time_ms": 850.1 }];

            const runAnalysis = async () => {
                setLoading(true);
                setError('');
                setResult(null);
                try {
                    const response = await axios.post('http://127.0.0.1:8000/api/gpu/analyze', { experiments: sampleExperiments });
                    setResult(response.data);
                } catch (err) {
                    setError('Failed to connect to backend API. Is the server running?');
                    console.error('API Error:', err);
                }
                setLoading(false);
            };
            
            const formatChartData = (impactData) => Object.entries(impactData || {}).map(([key, value]) => ({ name: key, 'GPU Time (ms)': value }));

            return React.createElement('div', { className: 'space-y-6' },
                React.createElement('div', { className: 'bg-slate-800 rounded-lg p-6' },
                    React.createElement('h2', { className: 'text-xl font-semibold mb-2' }, 'Training Efficiency Monitor'),
                    React.createElement('p', { className: 'text-slate-400 mb-4' }, '"You can\'t optimize what you can\'t explain." Find compute waste in training logs.'),
                    React.createElement('button', { onClick: runAnalysis, disabled: loading, className: 'bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg font-medium disabled:opacity-50' }, loading ? 'Analyzing...' : 'Assess Efficiency')
                ),
                error && React.createElement('div', { className: 'bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg' }, error),
                result && React.createElement(React.Fragment, null,
                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                        React.createElement('div', { className: 'bg-slate-800 rounded-lg p-4 text-center' },
                            React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Potential Savings'),
                            React.createElement('p', { className: 'text-3xl font-bold text-green-400 mt-1' }, `${result.potential_savings_pct?.toFixed(1) || 'N/A'}%`)
                        ),
                        React.createElement('div', { className: 'bg-slate-800 rounded-lg p-4 text-center' },
                            React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Avg. GPU Time'),
                            React.createElement('p', { className: 'text-3xl font-bold mt-1' }, `${result.avg_gpu_time.toFixed(0)} ms`)
                        )
                    ),
                    React.createElement('div', { className: 'bg-slate-800 rounded-lg p-6' },
                        React.createElement('h3', { className: 'font-semibold mb-4' }, 'Impact of Batch Size on GPU Time'),
                        React.createElement(ResponsiveContainer, { width: '100%', height: 300 },
                            React.createElement(BarChart, { data: formatChartData(result.batch_size_impact) },
                                React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#374151' }),
                                React.createElement(XAxis, { dataKey: 'name', stroke: '#9ca3af' }),
                                React.createElement(YAxis, { stroke: '#9ca3af' }),
                                React.createElement(Tooltip, { contentStyle: { backgroundColor: '#1e293b', border: '1px solid #374151' } }),
                                React.createElement(Bar, { dataKey: 'GPU Time (ms)', fill: '#06b6d4' })
                            )
                        )
                    )
                )
            );
        };

        // --- ROI Panel Component (WITH THE NEW "REASON" CARD) ---
        const ROIPanel = () => {
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const runSimulation = async () => {
                setLoading(true);
                setError('');
                setResult(null);
                try {
                    const response = await axios.post('http://127.0.0.1:8000/api/roi/simulate', {});
                    setResult(response.data);
                } catch (err) {
                    setError('Failed to connect to backend API. Is the server running?');
                    console.error('API Error:', err);
                }
                setLoading(false);
            };
            
            let triggerReason = null;
            if (result && result.breach_period) {
                const breachData = result.timeline.find(p => p.period === result.breach_period);
                if (breachData) {
                    const retrainingCost = 6000; // This should ideally come from the API
                    triggerReason = `The model's projected net value of $${breachData.net_roi.toLocaleString()} dropped below the retraining cost of $${retrainingCost.toLocaleString()} for two consecutive months.`;
                }
            }

            return React.createElement('div', { className: 'space-y-6' },
                React.createElement('div', { className: 'bg-slate-800 rounded-lg p-6' },
                    React.createElement('h2', { className: 'text-xl font-semibold mb-2' }, 'Lifecycle & ROI Monitor'),
                    React.createElement('p', { className: 'text-slate-400 mb-4' }, '"Retrain for reason, not for vibes." Find the economic break-even point for retraining.'),
                    React.createElement('button', { onClick: runSimulation, disabled: loading, className: 'bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg font-medium disabled:opacity-50' }, loading ? 'Simulating...' : 'Assess Retraining ROI')
                ),
                error && React.createElement('div', { className: 'bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg' }, error),
                result && React.createElement(React.Fragment, null,
                     React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
                        React.createElement('div', { className: 'bg-slate-800 rounded-lg p-4 text-center' },
                            React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Total 12-Month Net Value'),
                            React.createElement('p', { className: `text-3xl font-bold mt-1 ${result.total_roi > 0 ? 'text-green-400' : 'text-red-400'}` }, `$${result.total_roi.toLocaleString()}`)
                        ),
                        React.createElement('div', { className: 'bg-slate-800 rounded-lg p-4 text-center' },
                            React.createElement('p', { className: 'text-slate-400 text-sm' }, 'Retrain Trigger'),
                            React.createElement('p', { className: 'text-3xl font-bold text-amber-400 mt-1' }, result.breach_period ? `Month ${result.breach_period}` : 'Not Triggered')
                        )
                    ),
                    triggerReason && React.createElement('div', { className: 'bg-amber-900/50 border border-amber-700 rounded-lg p-4' },
                        React.createElement('h3', { className: 'font-semibold text-amber-300 mb-2' }, 'Reason for Trigger'),
                        React.createElement('p', { className: 'text-slate-300 text-sm' }, triggerReason)
                    ),
                    React.createElement('div', { className: 'bg-slate-800 rounded-lg p-6 mt-4' },
                        React.createElement('h3', { className: 'font-semibold mb-4' }, 'Economic Impact of Model Decay'),
                        React.createElement(ResponsiveContainer, { width: '100%', height: 400 },
                            React.createElement(LineChart, { data: result.timeline },
                                React.createElement(CartesianGrid, { strokeDasharray: '3 3', stroke: '#374151' }),
                                React.createElement(XAxis, { dataKey: 'period', stroke: '#9ca3af', label: { value: 'Month', position: 'insideBottom', offset: -5 } }),
                                React.createElement(YAxis, { stroke: '#9ca3af', tickFormatter: (value) => `$${value/1000}k` }),
                                React.createElement(Tooltip, { contentStyle: { backgroundColor: '#1e293b', border: '1px solid #374151' }, formatter: (value) => `$${value.toLocaleString()}` }),
                                React.createElement(Legend, null),
                                React.createElement(ReferenceLine, { y: 0, stroke: '#475569' }),
                                React.createElement(Line, { type: 'monotone', dataKey: 'net_roi', name: 'Monthly Net Value', stroke: '#ef4444' }),
                                React.createElement(Line, { type: 'monotone', dataKey: 'cum_roi', name: 'Cumulative Net Value', stroke: '#22c55e', strokeWidth: 2 }),
                                result.breach_period && React.createElement(ReferenceLine, { x: result.breach_period, stroke: '#f59e0b', label: { value: 'Retrain Trigger', fill: '#f59e0b' } })
                            )
                        )
                    )
                )
            );
        };
        
        // --- Main App Component ---
        function App() {
            const [activeTab, setActiveTab] = useState('integrity');
            const tabs = [{ id: 'integrity', label: 'Data Integrity' }, { id: 'gpu', label: 'GPU Efficiency' }, { id: 'roi', label: 'ROI Monitor' }];

            return React.createElement('div', { className: 'min-h-screen bg-slate-900' },
                React.createElement('header', { className: 'bg-slate-800 border-b border-slate-700' },
                    React.createElement('div', { className: 'max-w-7xl mx-auto px-4 py-6' },
                        React.createElement('h1', { className: 'text-3xl font-bold text-white' }, 'AI Trust Fabric'),
                        React.createElement('p', { className: 'text-slate-400 mt-1' }, 'Decision Integrity Platform')
                    )
                ),
                React.createElement('div', { className: 'max-w-7xl mx-auto px-4 mt-6' },
                    React.createElement('div', { className: 'border-b border-slate-700' },
                        React.createElement('nav', { className: 'flex space-x-8' },
                            tabs.map(tab => React.createElement('button', {
                                key: tab.id,
                                onClick: () => setActiveTab(tab.id),
                                className: `pb-4 px-1 border-b-2 font-medium text-sm transition-colors ${activeTab === tab.id ? 'border-cyan-500 text-cyan-500' : 'border-transparent text-slate-400 hover:text-slate-300'}`
                            }, tab.label))
                        )
                    )
                ),
                React.createElement('main', { className: 'max-w-7xl mx-auto px-4 py-8' },
                    activeTab === 'integrity' && React.createElement(IntegrityPanel),
                    activeTab === 'gpu' && React.createElement(GPUPanel),
                    activeTab === 'roi' && React.createElement(ROIPanel)
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>